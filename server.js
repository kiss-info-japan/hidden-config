

require('dotenv').config();
const express = require('express');
const cors = require('cors');
const fetch = require('node-fetch');

const app = express();
const PORT = 3000;

app.use(cors());
app.use(express.json());

const MISTRAL_API_KEY = process.env.MISTRAL_API_KEY;
if (!MISTRAL_API_KEY) {
    console.error("ğŸš¨ MISTRAL_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼.env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    process.exit(1);
}

const MISTRAL_API_URL = "https://api.mistral.ai/v1/chat/completions";

// ğŸ“Œ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
const userSessions = {};

// ğŸ“Œ è¨ºæ–­ãƒ†ã‚¹ãƒˆé–‹å§‹API
app.post('/start-diagnosis', async (req, res) => {
    const { userId } = req.body;
    if (!userId) {
        return res.status(400).json({ error: "userId ãŒå¿…è¦ã§ã™ã€‚" });
    }

    try {
        // AIã«è¨ºæ–­ç”¨ã®è³ªå•ã‚’ç”Ÿæˆã•ã›ã‚‹
        const questionPrompt = `
        å®—æ•™è¦³ã‚’è¨ºæ–­ã™ã‚‹ãŸã‚ã®è³ªå•ã‚’15å€‹è€ƒãˆã¦ãã ã•ã„ã€‚
        - è‡ªç”±å›ç­”å½¢å¼ã®è³ªå•ã«ã™ã‚‹ã“ã¨ã€‚
        - æ—¥æœ¬èªã§ã€ä¸è‡ªç„¶ãªè¨€ã„å›ã—ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚
        - ä¿¡ä»°ã€ä¾¡å€¤è¦³ã€é‹å‘½ã€ç¥ã€æ­»å¾Œã®ä¸–ç•Œã€é­‚ãªã©ã«é–¢ã™ã‚‹çŸ¥è­˜ãŒãªãã€ä¾¡å€¤è¦³ãŒæ±ºã¾ã‚Šåˆ‡ã£ã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã£ã¦ã‚‚ã€è‡ªã‚‰ã®ä¾¡å€¤è¦³ã‚’æ”¹ã‚ã¦è€ƒãˆãªãŒã‚‰åˆ¤æ–­ã§ãã‚‹ã‚ˆã†ãªè³ªå•ã«ã™ã‚‹ã€‚
        
        ä¾‹:  
1. ã‚ãªãŸã«ã¨ã£ã¦ã€Œå¿ƒãŒè½ã¡ç€ãç¬é–“ã€ã¯ã©ã‚“ãªã¨ãã§ã™ã‹ï¼Ÿ  
2. ä½•ã‹å¤§ããªå›°é›£ã«ç›´é¢ã—ãŸã¨ãã€ã©ã‚“ãªãµã†ã«ä¹—ã‚Šè¶Šãˆã‚ˆã†ã¨ã—ã¾ã™ã‹ï¼Ÿ  
3. ä½•ã‹ã‚’ã€Œæ­£ã—ã„ã€ã€Œé–“é•ã£ã¦ã„ã‚‹ã€ã¨åˆ¤æ–­ã™ã‚‹ã¨ãã€ã©ã‚“ãªåŸºæº–ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ  
4. ã€Œç›®ã«è¦‹ãˆãªã„ã‚‚ã®ã€ã«å½±éŸ¿ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿãã‚Œã¯ã©ã‚“ãªã‚‚ã®ã§ã™ã‹ï¼Ÿ  
5. ã‚‚ã—ã€ä»Šã¨ã¯é•ã†æ–‡åŒ–ã‚„æ™‚ä»£ã«ç”Ÿã¾ã‚Œã¦ã„ãŸã‚‰ã€ã‚ãªãŸã®ä¾¡å€¤è¦³ã¯ã©ã†å¤‰ã‚ã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ  
6. ã‚ãªãŸãŒã€Œã“ã‚Œã¯çµ¶å¯¾ã«å®ˆã‚ŠãŸã„ã€ã¨æ€ã†ãƒ«ãƒ¼ãƒ«ã‚„è€ƒãˆæ–¹ã¯ä½•ã§ã™ã‹ï¼Ÿ  
7. èª°ã‹ã«åŠ©ã‘ã¦ã‚‚ã‚‰ã£ãŸçµŒé¨“ãŒã‚ã‚Œã°ã€ãã‚Œã¯ã©ã‚“ãªçŠ¶æ³ã§ã—ãŸã‹ï¼Ÿ  
8. é€†ã«ã€èª°ã‹ã‚’åŠ©ã‘ãŸçµŒé¨“ãŒã‚ã‚Œã°ã€ãã‚Œã¯ã©ã‚“ãªçŠ¶æ³ã§ã—ãŸã‹ï¼Ÿ  
9. ã€Œé‹ãŒã„ã„ã€ã€Œé‹ãŒæ‚ªã„ã€ã¨æ„Ÿã˜ã‚‹ã®ã¯ã©ã‚“ãªã¨ãã§ã™ã‹ï¼Ÿ  
10. è‡ªåˆ†ãŒå¤§äº‹ã«ã—ã¦ã„ã‚‹ç¿’æ…£ã‚„å„€å¼ã®ã‚ˆã†ãªã‚‚ã®ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿãã‚Œã¯ã©ã‚“ãªã‚‚ã®ã§ã™ã‹ï¼Ÿ
        `;

        const response = await fetch(MISTRAL_API_URL, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${MISTRAL_API_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'mistral-medium',
                messages: [{ role: 'user', content: questionPrompt }]
            })
        });

        const data = await response.json();
        if (!response.ok) {
            console.error("ğŸš¨ Mistral API ã‚¨ãƒ©ãƒ¼:", data);
            throw new Error(data.error || 'Mistral API error');
        }

        // è³ªå•ãƒªã‚¹ãƒˆã‚’å–å¾—
        const questions = data.choices[0].message.content
            .split('\n')
            .map(q => q.replace(/^\d+\.\s*/, '').trim())
            .filter(q => q.length > 0);

        if (questions.length < 15) {
            return res.status(500).json({ error: "è³ªå•ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚" });
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
        userSessions[userId] = { questions, answers: [] };

        // æœ€åˆã®è³ªå•ã‚’é€ä¿¡
        res.json({ reply: `Hidden Config\n\nå¤šãã®æ—¥æœ¬äººã¯ç„¡å®—æ•™ã¨ã•ã‚Œã‚‹ãŒã€å®Ÿéš›ã«ã¯æ–‡åŒ–ã‚„ç¤¾ä¼šçš„å½±éŸ¿ã«ã‚ˆã£ã¦ç„¡æ„è­˜ã®ã†ã¡ã«ä¿¡å¿µãŒå½¢æˆã•ã‚Œã¦ã„ã‚‹ã€‚\n\nãã—ã¦ã€ãã®ä¿¡å¿µã¯PCã®éš ã—è¨­å®šï¼ˆHidden Configï¼‰ã®ã‚ˆã†ã«ã€ç§ãŸã¡ã®è¨€å‹•ã«çŸ¥ã‚‰ãšçŸ¥ã‚‰ãšã®ã†ã¡ã«ä½œç”¨ã—ç¶šã‘ã‚‹ã€‚\n\nã“ã®ã‚µã‚¤ãƒˆã§ã¯ã€AIãŒç”Ÿæˆã—ãŸ15ã®è³ªå•ã«ç­”ãˆã‚‹ã“ã¨ã§ã€ã‚ãªãŸã«æœ€é©ãªå®—æ•™ãŒææ¡ˆã•ã‚Œã‚‹ã€‚\n\nãã®çµæœã«é•å’Œæ„Ÿã‚’è¦šãˆãŸãªã‚‰ã€\n\nãã‚Œã¯ç„¡è‡ªè¦šã®ä¿¡å¿µãŒã‚ãªãŸã®æ€è€ƒã‚’æ”¯é…ã—ã¦ã„ã‚‹ã“ã¨ã«æ°—ã¥ãç¬é–“ã§ã‚ã‚Šã€\n\nåŒæ™‚ã«ã€ã‚ãªãŸã®ä¸­ã«ã™ã§ã«å®—æ•™ãŒå­˜åœ¨ã—ã¦ã„ã‚‹ã“ã¨ã«æ°—ã¥ãç¬é–“ã§ã‚‚ã‚ã‚‹ã€‚\n\n\n\nè¨ºæ–­ã‚’é–‹å§‹\n${questions[0]}` });

    } catch (error) {
        console.error("ğŸš¨ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼:", error);
        res.status(500).json({ error: error.message });
    }
});

// ğŸ“Œ è¨ºæ–­ãƒ†ã‚¹ãƒˆã®é€²è¡ŒAPI
app.post('/chat', async (req, res) => {
    try {
        const { userId, message } = req.body;
        if (!userId || !message) {
            return res.status(400).json({ error: "userIdã¨messageãŒå¿…è¦ã§ã™ã€‚" });
        }

        // è¨ºæ–­ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆ
        if (!userSessions[userId]) {
            return res.status(400).json({ error: "è¨ºæ–­ãŒã¾ã é–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚" });
        }

        const session = userSessions[userId];
        session.answers.push(message);

        // æ¬¡ã®è³ªå•ã‚’é€ã‚‹
        const nextQuestionIndex = session.answers.length;
        if (nextQuestionIndex < session.questions.length) {
            res.json({
                reply: `${nextQuestionIndex + 1}ç•ªç›®ã®è³ªå•:\n${session.questions[nextQuestionIndex]}`
            });
        } else {
            // ğŸ“Œ è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆMistral AI ã«ä¾é ¼ï¼‰
            const diagnosisPrompt = `
            ä»¥ä¸‹ã®è³ªå•ã¨å›ç­”ã«åŸºã¥ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•åŸç†ã‚’æ”¯ãˆã‚‹ã€ŒHidden Configã€ã‚’è§£æã—ã€æœ€é©ãªã€ŒInstalled Religionã€ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚

            ã€è¨ºæ–­ãƒ«ãƒ¼ãƒ«ã€‘
            - ä»¥ä¸‹ã®ãƒªã‚¹ãƒˆã‹ã‚‰æœ€ã‚‚é©ã—ãŸã‚‚ã®ã‚’1ã¤é¸æŠã—ã¦ãã ã•ã„ã€‚
        ã€ãƒªã‚¹ãƒˆã€‘
- "ã‚¤ã‚¹ãƒ©ãƒ æ•™", "ãƒ’ãƒ³ãƒ‰ã‚¥ãƒ¼æ•™", "ä»æ•™", "ã‚·ã‚¯æ•™", "ãƒ¦ãƒ€ãƒ¤æ•™", "é“æ•™", "ãƒãƒãƒ¼ã‚¤æ•™", "ç¥é“", "ã‚¾ãƒ­ã‚¢ã‚¹ã‚¿ãƒ¼æ•™", "ã‚·ãƒ£ãƒ¼ãƒãƒ‹ã‚ºãƒ ", "ã‚µã‚¿ãƒ‹ã‚ºãƒ ", "ã‚¯ãƒªã‚¹ãƒãƒ£ãƒ³ãƒ»ã‚µã‚¤ã‚¨ãƒ³ã‚¹", "ãƒ ã‚¹ãƒªãƒ ãƒ»ã‚·ãƒ¼ã‚¢æ´¾", "ãƒ ã‚¹ãƒªãƒ ãƒ»ã‚¹ãƒ³ãƒ‹æ´¾", "ãƒ¢ãƒ«ãƒ¢ãƒ³æ•™", "ã‚¢ãƒ•ãƒªã‚«ä¼çµ±å®—æ•™", "ã‚«ãƒãƒ©", "ãƒ´ã‚£ã‚·ãƒ¥ãƒŒæ•™", "ã‚¸ãƒ£ã‚¤ãƒŠæ•™", "ãƒ­ãƒ¼ãƒã‚«ãƒˆãƒªãƒƒã‚¯", "ãƒ—ãƒ­ãƒ†ã‚¹ã‚¿ãƒ³ãƒˆ", "ã‚¢ãƒ³ã‚°ãƒªã‚«ãƒ³æ•™", "ãƒ‹ã‚³ãƒ©ã‚¦ã‚¹ä¸»ç¾©", "ãƒ¡ã‚½ãƒã‚¿ãƒŸã‚¢å®—æ•™", "ã‚¨ã‚¸ãƒ—ãƒˆç¥æ®¿ä¿¡ä»°", "ã‚¢ã‚¹ãƒ†ã‚«å®—æ•™", "ã‚¤ãƒ³ã‚«å®—æ•™", "ãƒãƒ«ãƒ‡ã‚£ãƒƒã‚¯å®—æ•™", "ã‚·ãƒ¥ãƒ¡ãƒ¼ãƒ«å®—æ•™", "ã‚¢ãƒ‹ãƒŸã‚ºãƒ ", "ãƒ˜ãƒ–ãƒ©ã‚¤å®—æ•™", "ã‚¿ã‚ªã‚¤", "ãƒŠãƒãƒ›æ•™", "ã‚±ãƒ«ãƒˆå®—æ•™", "ãƒãƒ¼ãƒ‹ã‚ºãƒ ", "ã‚¶ãƒ©ã‚¹ã‚·ãƒ¥ãƒˆãƒ©æ•™", "ã‚¤ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³å®—æ•™", "ãƒãƒ™ãƒƒãƒˆä»æ•™", "ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒªã‚ºãƒ ", "ã‚µãƒ³ãƒ†ãƒªã‚¢", "ãƒ´ãƒ¼ãƒ‰ã‚¥ãƒ¼", "ã‚ªãƒªã‚·ãƒ£ä¿¡ä»°", "ã‚¦ã‚£ãƒƒã‚«"  

            è³ªå•ã¨å›ç­”:
            ${session.questions.map((q, i) => `Q: ${q}\nA: ${session.answers[i]}`).join('\n')}

            ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
            - **è¨ºæ–­çµæœ:** ã€ŒInstalled Religion: â—‹â—‹ã€
            - **è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ:**
              - â—‹â—‹ãŒã©ã®ã‚ˆã†ãªä¿¡å¿µä½“ç³»ã§ã‚ã‚‹ã‹ã‚’æ—¥æœ¬èªã§ç°¡æ½”ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
              - ãªãœãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Hidden Configã«é©åˆã™ã‚‹ã®ã‹ã‚’è«–ç†çš„ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
              - ãã®å®—æ•™ã®æ­´å²çš„èƒŒæ™¯ãŠã‚ˆã³ç¤¾ä¼šæ–‡åŒ–çš„å½±éŸ¿ã‚’ç°¡æ½”ã«æç¤ºã—ã¦ãã ã•ã„ã€‚
            - **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•å‚¾å‘åˆ†æ:**
              - å›ç­”å†…å®¹ã‹ã‚‰å°ãå‡ºã›ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•åŸç†ã€æ€æƒ³çš„å‚¾å‘ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
              - ã€Œä¿¡ä»°ã€ã€Œç§©åºã€ã€Œè‡ªç”±ã€ã€Œåˆç†ã€ã€ŒéœŠæ€§ã€ãªã©ã®è»¸ã§åˆ†é¡ã—ã€ã©ã®ç‰¹æ€§ãŒå¼·ã„ã‹ç¤ºã—ã¦ãã ã•ã„ã€‚
            `;

            const diagnosisResponse = await fetch(MISTRAL_API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${MISTRAL_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'mistral-medium',
                    messages: [{ role: 'user', content: diagnosisPrompt }]
                })
            });

            const diagnosisData = await diagnosisResponse.json();
            if (!diagnosisResponse.ok) {
                console.error("ğŸš¨ è¨ºæ–­APIã‚¨ãƒ©ãƒ¼:", diagnosisData);
                throw new Error(diagnosisData.error || 'Mistral API error');
            }

            // ğŸ“Œ è¨ºæ–­çµæœã‚’å–å¾—
            const diagnosisResult = diagnosisData.choices[0].message.content.trim();

            // è¨ºæ–­çµæœã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡
            res.json({
                reply: `è¨ºæ–­ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\n${diagnosisResult}`
            });

            // è¨ºæ–­çµæœã‚’ä¿å­˜ï¼ˆä»»æ„ï¼‰
            session.diagnosis = diagnosisResult;
        }
    } catch (error) {
        console.error("ğŸš¨ ã‚¨ãƒ©ãƒ¼:", error);
        res.status(500).json({ error: error.message });
    }
});

app.listen(PORT, () => {
    console.log(`ğŸš€ ã‚µãƒ¼ãƒãƒ¼ãŒãƒãƒ¼ãƒˆ ${PORT} ã§èµ·å‹•ã—ã¾ã—ãŸ`);
});
